"""source gebieden bouwblokken model from ams schema

Revision ID: 94622e8d6a47
Revises: cb2066efabfb
Create Date: 2022-08-11 11:59:07.557188

"""
from alembic import op
import sqlalchemy as sa
import geoalchemy2
from sqlalchemy.dialects import postgresql

from gobupload.alembic_utils import RenamedRelation, upgrade_relations, downgrade_relations

# revision identifiers, used by Alembic.
revision = '94622e8d6a47'
down_revision = 'cb2066efabfb'
branch_labels = None
depends_on = None


renamed_relations = [
    RenamedRelation(
        table_name='gebieden_bouwblokken',
        old_column='ligt_in_buurt',
        new_column='ligt_in_gebieden_buurt',
        old_relation_table='rel_gbd_bbk_gbd_brt_ligt_in_buurt',
        new_relation_table='rel_gbd_bbk_gbd_brt_ligt_in_gebieden_buurt'
    ),
    RenamedRelation(
        table_name='gebieden_bouwblokken',
        old_column='ligt_in_gemeente',
        new_column='ligt_in_brk_gemeente',
        old_relation_table='rel_gbd_bbk_brk_gme_ligt_in_gemeente',
        new_relation_table='rel_gbd_bbk_brk_gme_ligt_in_brk_gemeente'
    )
]


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("DROP VIEW legacy.meetbouten_rollagen_enhanced")
    op.execute("DROP VIEW legacy.gebieden_bouwblokken")

    op.add_column('gebieden_bouwblokken', sa.Column('datum_actueel_tot', sa.DateTime(), autoincrement=False, nullable=True))
    op.alter_column('gebieden_bouwblokken', 'geometrie',
               existing_type=geoalchemy2.types.Geometry(srid=28992),
               type_=geoalchemy2.types.Geometry(geometry_type='POLYGON', srid=28992),
               existing_nullable=True)

    upgrade_relations(op, renamed_relations)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("DROP VIEW legacy.meetbouten_rollagen_enhanced")
    op.execute("DROP VIEW legacy.gebieden_bouwblokken")

    op.alter_column('gebieden_bouwblokken', 'geometrie',
               existing_type=geoalchemy2.types.Geometry(geometry_type='POLYGON', srid=28992),
               type_=geoalchemy2.types.Geometry(srid=28992),
               existing_nullable=True)
    op.drop_column('gebieden_bouwblokken', 'datum_actueel_tot')

    downgrade_relations(op, renamed_relations)
    # ### end Alembic commands ###
